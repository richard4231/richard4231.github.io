// Konstanten
const MARGIN = 20;
const BASE_SIZE = 40;
const CAMERA_POSITION = {x: -440, y: -450, z: 1100};
const CAMERA_TARGET = {x: 150, y: 100, z: 0}; // x erhöhen => Bild erscheint mehr nach links
const DEFAULT_BACKGROUND = 220;
const LI_FACTOR = 10;
const GUI_WIDTH = 220;  // Breite des GUI-Panels
const GUI_TOP = 40;     // Top-Position des GUI

// Variablen für die GUI
var slider1x = 1;
var slider1y = 1;
var slider1z = 1;
var speed = 0.5;
var power = 3;
var orbControl = 1;
var lightIntensity = 60;

// Konstanten für Slider-Bereiche
var slider1xMin = 0;
var slider1xMax = 1.5;
var slider1xStep = 0.05;
var slider1yMin = 0;
var slider1yMax = 1.5;
var slider1yStep = 0.05;
var slider1zMin = 0;
var slider1zMax = 1.5;
var slider1zStep = 0.05;

var speedMin = -2;
var speedMax = 2;
var speedStep = 0.1;

var powerMin = 1;
var powerMax = 6;
var powerStep = 1;

var orbControlMin = 0;
var orbControlMax = 1;
var orbControlStep = 1;

var lightIntensityMin = 0;
var lightIntensityMax = 100;
var lightIntensityStep = 5;

// Kamera und Hilfsvariablen
let camx;
let camy;
let camz;
let gui;

p5.disableFriendlyErrors = true;

// Würfelkonfigurationen als Matrizen
const MATRICES = {
    2: [1,2,2,1],
    4: [1,2,3,4,2,1,4,3,3,4,1,2,4,3,2,1],
    8: [1,2,3,4,5,6,7,8,
		2,1,4,3,6,5,8,7,
		3,4,1,2,7,8,5,6,
		4,3,2,1,8,7,6,5,
		5,6,7,8,1,2,3,4,
		6,5,8,7,2,1,4,3,
		7,8,5,6,3,4,1,2,
		8,7,6,5,4,3,2,1],
    16: [1,2,3,4,5,6,7,8, 9,10,11,12,13,14,15,16,
		2,1,4,3,6,5,8,7, 10,9,12,11,14,13,16,15,
		3,4,1,2,7,8,5,6, 11,12,9,10,15,16,13,14,
		4,3,2,1,8,7,6,5, 12,11,10,9,16,15,14,13,
		5,6,7,8,1,2,3,4, 13,14,15,16,9,10,11,12,
		6,5,8,7,2,1,4,3, 14,13,16,15,10,9,12,11,
		7,8,5,6,3,4,1,2, 15,16,13,14,11,12,9,10,
		8,7,6,5,4,3,2,1, 16,15,14,13,12,11,10,9,

		9,10,11,12,13,14,15,16, 1,2,3,4,5,6,7,8,
		10,9,12,11,14,13,16,15, 2,1,4,3,6,5,8,7,
		11,12,9,10,15,16,13,14, 3,4,1,2,7,8,5,6,
		12,11,10,9,16,15,14,13,	4,3,2,1,8,7,6,5,
		13,14,15,16,9,10,11,12,	5,6,7,8,1,2,3,4,
		14,13,16,15,10,9,12,11,	6,5,8,7,2,1,4,3,
		15,16,13,14,11,12,9,10,	7,8,5,6,3,4,1,2,
		16,15,14,13,12,11,10,9, 8,7,6,5,4,3,2,1],
    32: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],
    64: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,34,33,36,35,38,37,40,39,42,41,44,43,46,45,48,47,50,49,52,51,54,53,56,55,58,57,60,59,62,61,64,63,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,35,36,33,34,39,40,37,38,43,44,41,42,47,48,45,46,51,52,49,50,55,56,53,54,59,60,57,58,63,64,61,62,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,36,35,34,33,40,39,38,37,44,43,42,41,48,47,46,45,52,51,50,49,56,55,54,53,60,59,58,57,64,63,62,61,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,37,38,39,40,33,34,35,36,45,46,47,48,41,42,43,44,53,54,55,56,49,50,51,52,61,62,63,64,57,58,59,60,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,38,37,40,39,34,33,36,35,46,45,48,47,42,41,44,43,54,53,56,55,50,49,52,51,62,61,64,63,58,57,60,59,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,39,40,37,38,35,36,33,34,47,48,45,46,43,44,41,42,55,56,53,54,51,52,49,50,63,64,61,62,59,60,57,58,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,40,39,38,37,36,35,34,33,48,47,46,45,44,43,42,41,56,55,54,53,52,51,50,49,64,63,62,61,60,59,58,57,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,41,42,43,44,45,46,47,48,33,34,35,36,37,38,39,40,57,58,59,60,61,62,63,64,49,50,51,52,53,54,55,56,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,42,41,44,43,46,45,48,47,34,33,36,35,38,37,40,39,58,57,60,59,62,61,64,63,50,49,52,51,54,53,56,55,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,43,44,41,42,47,48,45,46,35,36,33,34,39,40,37,38,59,60,57,58,63,64,61,62,51,52,49,50,55,56,53,54,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,44,43,42,41,48,47,46,45,36,35,34,33,40,39,38,37,60,59,58,57,64,63,62,61,52,51,50,49,56,55,54,53,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,45,46,47,48,41,42,43,44,37,38,39,40,33,34,35,36,61,62,63,64,57,58,59,60,53,54,55,56,49,50,51,52,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,46,45,48,47,42,41,44,43,38,37,40,39,34,33,36,35,62,61,64,63,58,57,60,59,54,53,56,55,50,49,52,51,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,47,48,45,46,43,44,41,42,39,40,37,38,35,36,33,34,63,64,61,62,59,60,57,58,55,56,53,54,51,52,49,50,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,50,49,52,51,54,53,56,55,58,57,60,59,62,61,64,63,34,33,36,35,38,37,40,39,42,41,44,43,46,45,48,47,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,51,52,49,50,55,56,53,54,59,60,57,58,63,64,61,62,35,36,33,34,39,40,37,38,43,44,41,42,47,48,45,46,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,52,51,50,49,56,55,54,53,60,59,58,57,64,63,62,61,36,35,34,33,40,39,38,37,44,43,42,41,48,47,46,45,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,53,54,55,56,49,50,51,52,61,62,63,64,57,58,59,60,37,38,39,40,33,34,35,36,45,46,47,48,41,42,43,44,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,54,53,56,55,50,49,52,51,62,61,64,63,58,57,60,59,38,37,40,39,34,33,36,35,46,45,48,47,42,41,44,43,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,55,56,53,54,51,52,49,50,63,64,61,62,59,60,57,58,39,40,37,38,35,36,33,34,47,48,45,46,43,44,41,42,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,56,55,54,53,52,51,50,49,64,63,62,61,60,59,58,57,40,39,38,37,36,35,34,33,48,47,46,45,44,43,42,41,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,57,58,59,60,61,62,63,64,49,50,51,52,53,54,55,56,41,42,43,44,45,46,47,48,33,34,35,36,37,38,39,40,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,58,57,60,59,62,61,64,63,50,49,52,51,54,53,56,55,42,41,44,43,46,45,48,47,34,33,36,35,38,37,40,39,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,59,60,57,58,63,64,61,62,51,52,49,50,55,56,53,54,43,44,41,42,47,48,45,46,35,36,33,34,39,40,37,38,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,60,59,58,57,64,63,62,61,52,51,50,49,56,55,54,53,44,43,42,41,48,47,46,45,36,35,34,33,40,39,38,37,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,61,62,63,64,57,58,59,60,53,54,55,56,49,50,51,52,45,46,47,48,41,42,43,44,37,38,39,40,33,34,35,36,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,62,61,64,63,58,57,60,59,54,53,56,55,50,49,52,51,46,45,48,47,42,41,44,43,38,37,40,39,34,33,36,35,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,63,64,61,62,59,60,57,58,55,56,53,54,51,52,49,50,47,48,45,46,43,44,41,42,39,40,37,38,35,36,33,34,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,33,36,35,38,37,40,39,42,41,44,43,46,45,48,47,50,49,52,51,54,53,56,55,58,57,60,59,62,61,64,63,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,35,36,33,34,39,40,37,38,43,44,41,42,47,48,45,46,51,52,49,50,55,56,53,54,59,60,57,58,63,64,61,62,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,36,35,34,33,40,39,38,37,44,43,42,41,48,47,46,45,52,51,50,49,56,55,54,53,60,59,58,57,64,63,62,61,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,37,38,39,40,33,34,35,36,45,46,47,48,41,42,43,44,53,54,55,56,49,50,51,52,61,62,63,64,57,58,59,60,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,38,37,40,39,34,33,36,35,46,45,48,47,42,41,44,43,54,53,56,55,50,49,52,51,62,61,64,63,58,57,60,59,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,39,40,37,38,35,36,33,34,47,48,45,46,43,44,41,42,55,56,53,54,51,52,49,50,63,64,61,62,59,60,57,58,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,40,39,38,37,36,35,34,33,48,47,46,45,44,43,42,41,56,55,54,53,52,51,50,49,64,63,62,61,60,59,58,57,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,41,42,43,44,45,46,47,48,33,34,35,36,37,38,39,40,57,58,59,60,61,62,63,64,49,50,51,52,53,54,55,56,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,42,41,44,43,46,45,48,47,34,33,36,35,38,37,40,39,58,57,60,59,62,61,64,63,50,49,52,51,54,53,56,55,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,43,44,41,42,47,48,45,46,35,36,33,34,39,40,37,38,59,60,57,58,63,64,61,62,51,52,49,50,55,56,53,54,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,44,43,42,41,48,47,46,45,36,35,34,33,40,39,38,37,60,59,58,57,64,63,62,61,52,51,50,49,56,55,54,53,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,45,46,47,48,41,42,43,44,37,38,39,40,33,34,35,36,61,62,63,64,57,58,59,60,53,54,55,56,49,50,51,52,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,46,45,48,47,42,41,44,43,38,37,40,39,34,33,36,35,62,61,64,63,58,57,60,59,54,53,56,55,50,49,52,51,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,47,48,45,46,43,44,41,42,39,40,37,38,35,36,33,34,63,64,61,62,59,60,57,58,55,56,53,54,51,52,49,50,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,50,49,52,51,54,53,56,55,58,57,60,59,62,61,64,63,34,33,36,35,38,37,40,39,42,41,44,43,46,45,48,47,18,17,20,19,22,21,24,23,26,25,28,27,30,29,32,31,2,1,4,3,6,5,8,7,10,9,12,11,14,13,16,15,51,52,49,50,55,56,53,54,59,60,57,58,63,64,61,62,35,36,33,34,39,40,37,38,43,44,41,42,47,48,45,46,19,20,17,18,23,24,21,22,27,28,25,26,31,32,29,30,3,4,1,2,7,8,5,6,11,12,9,10,15,16,13,14,52,51,50,49,56,55,54,53,60,59,58,57,64,63,62,61,36,35,34,33,40,39,38,37,44,43,42,41,48,47,46,45,20,19,18,17,24,23,22,21,28,27,26,25,32,31,30,29,4,3,2,1,8,7,6,5,12,11,10,9,16,15,14,13,53,54,55,56,49,50,51,52,61,62,63,64,57,58,59,60,37,38,39,40,33,34,35,36,45,46,47,48,41,42,43,44,21,22,23,24,17,18,19,20,29,30,31,32,25,26,27,28,5,6,7,8,1,2,3,4,13,14,15,16,9,10,11,12,54,53,56,55,50,49,52,51,62,61,64,63,58,57,60,59,38,37,40,39,34,33,36,35,46,45,48,47,42,41,44,43,22,21,24,23,18,17,20,19,30,29,32,31,26,25,28,27,6,5,8,7,2,1,4,3,14,13,16,15,10,9,12,11,55,56,53,54,51,52,49,50,63,64,61,62,59,60,57,58,39,40,37,38,35,36,33,34,47,48,45,46,43,44,41,42,23,24,21,22,19,20,17,18,31,32,29,30,27,28,25,26,7,8,5,6,3,4,1,2,15,16,13,14,11,12,9,10,56,55,54,53,52,51,50,49,64,63,62,61,60,59,58,57,40,39,38,37,36,35,34,33,48,47,46,45,44,43,42,41,24,23,22,21,20,19,18,17,32,31,30,29,28,27,26,25,8,7,6,5,4,3,2,1,16,15,14,13,12,11,10,9,57,58,59,60,61,62,63,64,49,50,51,52,53,54,55,56,41,42,43,44,45,46,47,48,33,34,35,36,37,38,39,40,25,26,27,28,29,30,31,32,17,18,19,20,21,22,23,24,9,10,11,12,13,14,15,16,1,2,3,4,5,6,7,8,58,57,60,59,62,61,64,63,50,49,52,51,54,53,56,55,42,41,44,43,46,45,48,47,34,33,36,35,38,37,40,39,26,25,28,27,30,29,32,31,18,17,20,19,22,21,24,23,10,9,12,11,14,13,16,15,2,1,4,3,6,5,8,7,59,60,57,58,63,64,61,62,51,52,49,50,55,56,53,54,43,44,41,42,47,48,45,46,35,36,33,34,39,40,37,38,27,28,25,26,31,32,29,30,19,20,17,18,23,24,21,22,11,12,9,10,15,16,13,14,3,4,1,2,7,8,5,6,60,59,58,57,64,63,62,61,52,51,50,49,56,55,54,53,44,43,42,41,48,47,46,45,36,35,34,33,40,39,38,37,28,27,26,25,32,31,30,29,20,19,18,17,24,23,22,21,12,11,10,9,16,15,14,13,4,3,2,1,8,7,6,5,61,62,63,64,57,58,59,60,53,54,55,56,49,50,51,52,45,46,47,48,41,42,43,44,37,38,39,40,33,34,35,36,29,30,31,32,25,26,27,28,21,22,23,24,17,18,19,20,13,14,15,16,9,10,11,12,5,6,7,8,1,2,3,4,62,61,64,63,58,57,60,59,54,53,56,55,50,49,52,51,46,45,48,47,42,41,44,43,38,37,40,39,34,33,36,35,30,29,32,31,26,25,28,27,22,21,24,23,18,17,20,19,14,13,16,15,10,9,12,11,6,5,8,7,2,1,4,3,63,64,61,62,59,60,57,58,55,56,53,54,51,52,49,50,47,48,45,46,43,44,41,42,39,40,37,38,35,36,33,34,31,32,29,30,27,28,25,26,23,24,21,22,19,20,17,18,15,16,13,14,11,12,9,10,7,8,5,6,3,4,1,2,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1]
};

function isMouseOverGui() {
    return (mouseX > width - GUI_WIDTH && mouseY > GUI_TOP);
}

function setupLighting() {
    // Lichtintensität wird jetzt durch den Slider gesteuert
    pointLight(lightIntensity * LI_FACTOR, lightIntensity * LI_FACTOR, lightIntensity * LI_FACTOR * 1.3, -200, -200, 200);  // Bläuliches Licht
    pointLight(lightIntensity * LI_FACTOR * 1.3, lightIntensity * LI_FACTOR, lightIntensity * LI_FACTOR, 200, 200, -200);   // Rötliches Licht
    
    // Umgebungslicht proportional zur gewählten Intensität
    let ambientIntensity =  60 + lightIntensity * LI_FACTOR * 0.2;  // 30% der Hauptlichtintensität
    ambientLight(ambientIntensity, ambientIntensity, ambientIntensity);
}

function getMatrix(n) {
    return MATRICES[n] || A2;
}

function setup() {
    createCanvas(windowWidth-2*MARGIN, windowHeight-2*MARGIN, WEBGL);
    pixelDensity(1);
    setAttributes('antialias', true);
    setAttributes('perPixelLighting', true);
    camera(
        CAMERA_POSITION.x,
        CAMERA_POSITION.y,
        CAMERA_POSITION.z,
        CAMERA_TARGET.x,
        CAMERA_TARGET.y,
        CAMERA_TARGET.z,
        0, 1, 0
    );
    colorMode(RGB,255,255,255,100);

    var gui = createGui('Regler. Doppelklick minimiert.');
    gui.setPosition(width - 220, 40);
    gui.addGlobals('slider1x','slider1y','slider1z','speed','power','orbControl', 'lightIntensity');
}

function draw() {
    n = pow(2,power);

	if (orbControl === 1 && !isMouseOverGui()) {
		orbitControl([1], [1], [1]);
		rotateY(frameCount * 0.01*speed);
	} else if (orbControl === 1 && isMouseOverGui()) {
		//orbitControl([1], [1], [1]);
		rotateY(frameCount * 0.01*speed);
	}

    size = BASE_SIZE*16/n;

    translate(-0.5*n*size,-0.5*n*size,-0.5*n*size);

    background(DEFAULT_BACKGROUND);

    setupLighting();

    hx = slider1x;
    hy = slider1y;
    hz = slider1z;
    sponge(n,hx,hy,hz);
}

function sponge(n,hx,hy,hz) {
    size1 = BASE_SIZE*16/n;
    const matrix = getMatrix(n);

    for (var i = 0; i < n; i++) {
        for (var j = 0; j < n; j++) {
            push();
            a = i+j*n;
            translate(i*size1*hx, matrix[a]*size1*hy, j*size1*hz);
            
            // Stärkere Grundfarben mit weniger Variation
            let hue = map(matrix[a], 1, n, 0, 360);
            colorMode(HSB, 360, 100, 100);
            let col = color(hue, 80, 70);
            colorMode(RGB, 255, 255, 255);
            
            // Weniger reflektierendes Material
            fill(col);
            noStroke();
            box(size1);
            pop();
        }
    }
}

function windowResized() {
    resizeCanvas(windowWidth-2*MARGIN, windowHeight-2*MARGIN);
    camera(
        CAMERA_POSITION.x,
        CAMERA_POSITION.y,
        CAMERA_POSITION.z,
        CAMERA_TARGET.x,
        CAMERA_TARGET.y,
        CAMERA_TARGET.z,
        0, 1, 0
    );
}